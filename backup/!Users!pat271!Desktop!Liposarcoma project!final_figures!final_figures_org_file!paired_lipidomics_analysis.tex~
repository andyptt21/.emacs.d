% Created 2019-05-02 Thu 17:16
% Intended LaTeX compiler: pdflatex
\documentclass[11pt]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{grffile}
\usepackage{longtable}
\usepackage{wrapfig}
\usepackage{rotating}
\usepackage[normalem]{ulem}
\usepackage{amsmath}
\usepackage{textcomp}
\usepackage{amssymb}
\usepackage{capt-of}
\usepackage{hyperref}
\author{Andrew Patt}
\date{\today}
\title{Paired analysis of lipidomic data}
\hypersetup{
 pdfauthor={Andrew Patt},
 pdftitle={Paired analysis of lipidomic data},
 pdfkeywords={},
 pdfsubject={These are just the figures which will be in the final paper, with minor edits to ensure consistency of font size, etc.},
 pdfcreator={Emacs 26.2 (Org mode 9.2)}, 
 pdflang={English}}
\begin{document}

\maketitle
\tableofcontents

In order to perform paired analysis, we need to match paired samples together.
\section{Building a key of sample pairs}
\label{sec:org709f3a1}
\begin{verbatim}
library(tidyverse)
setwd("~/Desktop/Liposarcoma project/Lipidyzer/")
sample_IDs<-read.csv("~/Desktop/Liposarcoma project/Lipidyzer/Sample_IDs.csv")
sample_info<-read.csv("Cell_Run_Order.csv")

mdm2lo_groups=c("863","815")
mdm2hi_groups=c("224","224A","224B","246","141")

POS_Numbers<-c()
for(i in 1:82){
    POS_Numbers<-
	c(POS_Numbers,
	  strsplit(
	      strsplit(
		  as.character(
		      sample_IDs$POSITIVE[i]),"_")[[1]][2],"-")[[1]][1])
}

POS_Cell_Lines<-c()
for(i in 1:82){
    POS_Cell_Lines<-c(POS_Cell_Lines,
		      strsplit(as.character(sample_IDs$POSITIVE[i]),"-")[[1]][2])
}

POS_MDM2_Status<-c()
for(i in POS_Cell_Lines){
  index<-match(i,sample_info$Number)
  POS_MDM2_Status<-c(POS_MDM2_Status,as.character(sample_info$CellLine[index]))
}

## POS_MDM2_Status<-sapply(POS_MDM2_Status,
##                         function(x) if(x %in% mdm2lo_groups)
##                                     {return("Low")}
##                                     else if (x %in% mdm2hi_groups)
##                                     {return("High")} else return(NA))

POS_Treatment_Status<-c()
for(i in POS_Cell_Lines){
  index<-match(i,sample_info$Number)
  POS_Treatment_Status<-c(POS_Treatment_Status,
			  as.character(sample_info$Treatment[index]))
}

POS_medium<-c()
for(i in POS_Cell_Lines){
  index<-match(i,sample_info$Number)
  POS_medium<-c(POS_medium,as.character(sample_info$Media[index]))
}

POS_sample_info<-data.frame(Run_Order=POS_Numbers,
			    Number=POS_Cell_Lines,
			    Cell_line=POS_MDM2_Status,
			    Treatment_Status=POS_Treatment_Status,
			    Medium=POS_medium)

POS_sample_info<-POS_sample_info[-52,]
POS_sample_info<-POS_sample_info[-40,]

paired_key <- POS_sample_info
paired_key <- paired_key %>% filter(!is.na(Cell_line))

\end{verbatim}


\section{Treated vs. Untreated}
\label{sec:org422e1eb}
\begin{verbatim}
load("~/Desktop/Liposarcoma project/final_figures/final_figures_org_file/figure3.Rda")

## Filter to treated vs untreated
library(dplyr)
library(lme4)
library(pbapply)

Treated_untreated_indices <-
    paired_key %>%
    filter(Medium=="DMEM") %>%
    select(Run_Order)

LM_area_DMEM <- LM_area %>%
    select(as.vector(t(Treated_untreated_indices)))

cell <-
    paired_key %>%
    filter(Medium=="DMEM") %>%
    select(Cell_line)

treatment <-
    paired_key %>%
    filter(Medium=="DMEM") %>%
    select(Treatment_Status)


TreVsUntreLMME<-pbapply(LM_area_DMEM, 1, function(x){
    df<-data.frame(y=x,cell=unlist(cell),treatment=unlist(treatment))
    colnames(df)[1]="y"
    fit.null<-lmer(y ~ (1|cell), data = df,REML=FALSE)
    fit<-lmer(y ~ treatment + (1|cell), data = df,REML=FALSE)
    anovaFit<-anova(fit.null,fit)
    return(anovaFit$'Pr(>Chisq)'[2])
})

TreVsUntreLMMEAdj<-p.adjust(TreVsUntreLMME,method="fdr")
hist(TreVsUntreLMMEAdj,breaks=100)

\end{verbatim}

\section{DMEM vs STDP}
\label{sec:org4fd43dc}
\begin{verbatim}

DMEM_STDP_indices <-
    paired_key %>%
    filter(Treatment_Status=="none") %>%
    select(Run_Order)

LM_area_untreated <- LM_area %>%
    select(as.vector(t(DMEM_STDP_indices)))

cell <-
    paired_key %>%
    filter(Treatment_Status=="none") %>%
    select(Cell_line)

medium <-
    paired_key %>%
    filter(Treatment_Status=="none") %>%
    select(Medium)


DMEMVsSTDPLMME<-pbapply(LM_area_untreated, 1, function(x){
    df<-data.frame(y=x,cell=unlist(cell),medium=unlist(medium))
    colnames(df)[1]="y"
    fit.null<-lmer(y ~ (1|cell), data = df,REML=FALSE)
    fit<-lmer(y ~ medium + (1|cell), data = df,REML=FALSE)
    anovaFit<-anova(fit.null,fit)
    return(anovaFit$'Pr(>Chisq)'[2])
})

DMEMVsSTDPLMMEAdj<-p.adjust(DMEMVsSTDPLMME,method="fdr")
hist(DMEMVsSTDPLMMEAdj,breaks=100)

\end{verbatim}

\section{Upsetr}
\label{sec:org2a375a7}
\begin{verbatim}
library(UpSetR)
library(readxl)
lipidomic_key<-read_xlsx("~/Desktop/Liposarcoma project/Lipidomics_key.xlsx",sheet=1)
library(RColorBrewer)

TreVsUntreLMMESig_ind <- which(TreVsUntreLMMEAdj < 0.05)
TreVsUntreLMMESig <- data.frame(p.val.adj=TreVsUntreLMMEAdj[TreVsUntreLMMESig_ind],
				class=lipidomic_key$`LM Main Class`[TreVsUntreLMMESig_ind])

DMEMVsSTDPLMMESig_ind <- which(DMEMVsSTDPLMMEAdj < 0.05)
DMEMVsSTDPLMMESig <- data.frame(p.val.adj=DMEMVsSTDPLMMEAdj[DMEMVsSTDPLMMESig_ind],
				class=lipidomic_key$`LM Main Class`[DMEMVsSTDPLMMESig_ind])

listInput <- list(Treated_vs_untreated = rownames(TreVsUntreLMMESig),
		  DMEM_vs_STDP = rownames(DMEMVsSTDPLMMESig))

upset(fromList(listInput),order.by="freq")

\end{verbatim}

91 lipids altered by treatment status, 223 altered by medium, 57 in
common between the two.

\section{Differences by treatment status}
\label{sec:org602867e}
\begin{verbatim}
library(reshape)
altered <- data.frame(altered=
			  table(TreVsUntreLMMESig$class)/nrow(TreVsUntreLMMESig))

background <- data.frame(background=
			     table(lipidomic_key$`LM Main Class`)/nrow(lipidomic_key))
colnames(altered)<-c("class","Significant")
colnames(background)<-c("class","Background")
plot.df<-left_join(background,altered)
plot.df <- plot.df %>%
    gather(backgroundfreq,alteredfreq,-class)
colnames(plot.df)<-c("class","test","freq")

ggplot(plot.df,aes(x=class,y=freq,alpha=test)) +
    geom_bar(stat="identity",position="dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle=45,hjust=1)) +
    ggtitle("Lipidomic differences based on atorvastatin treatment (LMME)")

\end{verbatim}

\section{Differences by medium}
\label{sec:org3cb8868}
\begin{verbatim}

altered <- data.frame(altered=
			  table(DMEMVsSTDPLMMESig$class)/nrow(DMEMVsSTDPLMMESig))

colnames(altered)<-c("class","Significant")

plot.df<-left_join(background,altered)
plot.df <- plot.df %>%
    gather(backgroundfreq,alteredfreq,-class)
colnames(plot.df)<-c("class","test","freq")

ggplot(plot.df,aes(x=class,y=freq,alpha=test)) +
    geom_bar(stat="identity",position="dodge") +
    theme_classic() +
    theme(axis.text.x = element_text(angle=45,hjust=1)) +
    ggtitle("Lipidomic differences based on cell media (LMME)")

\end{verbatim}
\end{document}
