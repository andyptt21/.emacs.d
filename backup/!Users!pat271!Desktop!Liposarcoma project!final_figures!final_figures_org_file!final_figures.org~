#+TITLE: Final figures for liposarcoma paper
#+AUTHOR: Andrew Patt
#+DESCRIPTION: These are just the figures which will be in the final paper, with minor edits to ensure consistency of font size, etc.

# As a reminder: interactively edit R code with C-c '
# Reference tutorial:[[https://orgmode.org/worg/org-contrib/babel/languages/ob-doc-R.html][link]]
# Toggle inline image display with C-c i

* MDM2 Hi vs. Low Comparisons [9/9]
- [X] DMEM/Untreated (lipidomics, univariate)  *Fig 3B (VP)*
- [X] DMEM/Untreated (metabolomics, univariate) *Fig 1C (Barplot)* 
- [X] Correlate DMEM/Untreated changes in lipidomics vs. metabolomics *Additional Figure*
- [X] DMEM/Treated *Fig 3B*
- [X] DMEM/Untreated *Fig 3B*
- [X] Venn Diagram of DMEM/Treated vs Untreated *Fig3E*
- [X] STDP/Untreated *Fig S3B*
- [X] DMEM/Treated *Fig S3B*
- [X] Venn Diagram of STDP/Untreated vs DMEM/Untreated *Fig S3D*

* Figure 1 "Tumors with high or low MDM2 amplification show distinct metabolomics profiles"
** Figure 1B
#+header: :width 8 :height 8 :R-dev-args
#+begin_src R :session "global" :file Figure1B.pdf :results output graphics :export both
  library(ggplot2)
  library(RaMP)  
  load("~/Desktop/Liposarcoma project/final_figures/data/fishersResults.Rda")

  combinedPathwaysSig <- FilterFishersResults(combinedFishers,
                                              p_fdradj_cutoff=0.1)
  threshold <- 0.05

  fishresult <- combinedPathwaysSig$fishresult #fishresult <-
  fishresult[which(fishresult$Pval <= threshold),]

  fishClustering<-list(fishresults=fishresult,analyte_type="both")
  fishClustering<-findCluster(fishClustering,perc_analyte_overlap=0.2,perc_pathway_overlap=0.2)
  length(fishClustering$cluster_list)

  fishresult <- fishClustering$fishresults

  bubbleDF <- data.frame(x=-log10(fishresult$Pval),
                         y=fishresult$pathwayName, inPath <-
                         fishresult$Num_In_Path, totPath <-
                         fishresult$Total_In_Path,
                         cluster=fishresult$cluster_assignment)
  library(dplyr)
  library(tidyr)

  bubbleDF <- bubbleDF[order(bubbleDF$x, decreasing = TRUE),]

  bubbleDF <- bubbleDF %>% separate_rows(cluster,sep=", ")

  bubbleDF$cluster <- sapply(bubbleDF$cluster, function(x)
  ifelse(x=="Did not cluster", return(x),
  return(paste0("Cluster ",x))))

  fig1B <- ggplot(bubbleDF,aes(y=x,x=reorder(y,x), fill = cluster)) +
    geom_bar(stat = "identity", colour = "black",position =
                                                   "dodge", width = 0.75) +
	#geom_hline(yintercept=-log10(0.1),linetype = "dotted") +
    theme_bw() + coord_flip() + labs(x = "", y = "-log10(pval)") +
    theme(axis.line = element_line(colour = "black"),
          axis.title=element_text(size=12,face="bold"),
          plot.title=element_text(size=14,face="bold"),
          axis.text.y=element_text(face="bold"), panel.grid.minor =
                                                   element_blank(), legend.position = "none", panel.background =
                                                                                                element_blank()) +
    scale_fill_brewer(palette="Set1") +
    facet_grid(cluster~.,space="free",scales="free") +
    theme(strip.text.y = element_text(size = 6))
  fig1B

#+end_src

#+RESULTS:
[[file:Figure1B.pdf]]

** Figure 1C
#+header: :width 8 :height 10 :R-dev-args
#+begin_src R :session "global" :file Figure1C.pdf :results graphics output :exports results
  load("~/Desktop/Liposarcoma project/final_figures/final_figures_org_file/figure1C.Rda")
  myPalette<-c("#8B008B","#808080","#008080","#46f0f0","#f58231","#3cb44b","#e6194b")
  fig1C <- ggplot(resMDM2HiLoSig,aes(x=reorder(name,log2fc), y=log2fc, fill = Class)) +
      ggtitle("Significant MDM2 Hi/Lo Metabolites") +
      geom_bar(stat = "identity", colour = "black") +
      coord_flip() +
      theme_bw() +
      ylab("log2(mean(MDM2hi)-mean(MDM2lo))") +
    theme(axis.title.y = element_blank(),
          axis.title.x = element_text(size=12,face="bold"),
          axis.text.y=element_text(size=10,face="bold"),
          axis.text.x=element_text(size=10)) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()) +
    scale_fill_manual(values=as.vector(myPalette)[c(1,2,5,3,4,6,7)]) +
    theme(legend.position="bottom",legend.direction="vertical")
  fig1C
#+end_src

#+RESULTS:
[[file:Figure1C.pdf]]

** Figure 1
#+header: :width 20 :height 10 :R-dev-args
#+begin_src R :session "global" :file Figure1.pdf :results graphics output :exports results
  library(cowplot)

  df <- data.frame()
  fig1A <- ggplot(df) +
      geom_point() +
      xlim(0, 10) +
      ylim(0, 10) +
      theme_void() +
      annotate("text",x=5,y=5,label="Cell viability")

  new_p1 <- plot_grid(fig1A,
		      fig1B,
		      labels = c('A','C'),
		      nrow = 2)
  figure1<-plot_grid(new_p1,
		     fig1C,
		     labels = c('','B'),
		     ncol = 2)

  figure1
#+end_src

#+RESULTS:
[[file:Figure1.pdf]]

* Figure 2: "DDLPS cell lines with high MDM2 amplification respond poorly to MDM2 inhibition" 
** Figure 2B
#+header: :width 18 :height 3 :R-dev-args
#+begin_src R :session "global" :file Figure2B.pdf :results output graphics :exports results
load("~/Desktop/Liposarcoma project/final_figures/final_figures_org_file/figure2B.Rda")
load("~/Desktop/Liposarcoma project/final_figures/final_figures_org_file/figure2D.Rda")
myPalette<-c("#8B008B","#808080","#008080","#46f0f0","#f58231","#3cb44b","#e6194b")

df = metabMDM2hi
gp1 = c(which(MDM2hiCells=="141RG5"),
        which(MDM2hiCells=="246RG5"))
gp2 = c(which(MDM2hiCells=="141"),
        which(MDM2hiCells== "246"))
T_test_results<-mydiff(df,gp1,gp2)
keepers=intersect(which(T_test_results$mypadj<0.1),c(which(T_test_results$log2fc>1),which(T_test_results$log2fc< -1)))
significant_peaks<-T_test_results[keepers,]
T_test_results$threshold = as.factor(abs(T_test_results$log2fc) > 1 & -log10(T_test_results$mypadj) > -log10(0.05))
T_test_results$class<-sapply(T_test_results$name, function(x){
    ifelse(x %in% mdm2Hi_Treated_vs_UntreatedSig$name,
           return(as.vector(mdm2Hi_Treated_vs_UntreatedSig$Class)[match(x,as.vector(mdm2Hi_Treated_vs_UntreatedSig$name))]),
           return(".Not significant"))
})

p = ggplot(data=T_test_results, aes(x=log2fc, y=-log10(mypadj), colour=class)) +
    geom_point(alpha=0.7, size=1.75) +
    scale_color_manual(values = c("gray80",as.vector(myPalette)[c(3,1,2,4,5)])) +
    theme_bw() +
    ggtitle("MDM2 High Cells") +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    ylab("-log10 p-value") +
    geom_hline(yintercept = -log10(0.05),lty = 2) +
    geom_vline(xintercept = 1, lty = 2) +
    geom_vline(xintercept = -1, lty = 2) +
    theme(plot.title = element_text(size=10)) +
    guides(colour=FALSE) +
    xlab("log2(mean(Treated))-log2(mean(Untreated))") +
    theme(plot.margin = unit(c(0,10,0,10), "lines"))

df = metabMDM2lo
gp1 = c(which(MDM2loCells=="863RG5"),
        which(MDM2loCells=="815RG5"))
gp2 = c(which(MDM2loCells=="863"),
        which(MDM2loCells== "815"))
T_test_results<-mydiff(df,gp1,gp2)
keepers=intersect(which(T_test_results$mypadj<0.1),c(which(T_test_results$log2fc>1),which(T_test_results$log2fc< -1)))
significant_peaks<-T_test_results[keepers,]
T_test_results$threshold = as.factor(abs(T_test_results$log2fc) > 1 & -log10(T_test_results$mypadj) > -log10(0.05))
T_test_results$class<-sapply(T_test_results$name, function(x){
    ifelse(x %in% mdm2Lo_Treated_vs_UntreatedSig$name,
           return(as.vector(mdm2Lo_Treated_vs_UntreatedSig$Class)[match(x,as.vector(mdm2Lo_Treated_vs_UntreatedSig$name))]),
           return(".Not significant"))
})

p2 = ggplot(data=T_test_results, aes(x=log2fc, y=-log10(mypadj), colour=class)) +
    geom_point(alpha=0.7, size=1.75) +
    scale_color_manual(values = c("gray80",as.vector(myPalette)[c(1,5,3,4,6,2,7)])) +
    theme_bw() +
    ggtitle("MDM2 Low Cells") +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
    ylab("-log10 p-value") +
    geom_hline(yintercept = -log10(0.05),lty = 2) +
    geom_vline(xintercept = 1, lty = 2) +
    geom_vline(xintercept = -1, lty = 2) +
    theme(plot.title = element_text(size=10)) +
    xlab("log2(mean(Treated))-log2(mean(Untreated))") +
    theme(plot.margin = unit(c(0,10,0,10), "lines"))

  fig2B <- plot_grid(p,p2,align="h",nrow=1,labels=c("A","B"),rel_widths = c(0.7,1))
  fig2B
#+end_src

#+RESULTS:
[[file:Figure2B.pdf]]

** Figure 2C
#+header: :width 6 :height 10 :R-dev-args
#+begin_src R :session "global" :file Figure2C.pdf :results output graphics :exports results
  load("~/Desktop/Liposarcoma project/final_figures/final_figures_org_file/figure2C.Rda")

  fig2C <- ggplot(mdm2Hi_Treated_vs_UntreatedSig,aes(x=reorder(name,log2fc), y=log2fc, fill = Class)) +
    ggtitle("MDM2 High Cells") +
    geom_bar(stat = "identity", colour = "black") +
    coord_flip() +
    theme_bw() +
    ylab("log2(mean(Treated)-mean(Untreated))") +
    theme(axis.title.y = element_blank(),
          axis.title.x = element_text(size=12,face="bold"),
          axis.text.y=element_text(face="bold"),
          axis.text.x=element_text(size=10)) +
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
      scale_fill_manual(values=as.vector(myPalette)[c(3,1,2,4,5)]) #+
      #theme(legend.position="bottom",legend.direction="vertical")
   fig2C
#+end_src

#+RESULTS:
[[file:Figure2C.pdf]]

** Figure 2D
#+header: :width 6 :height 12 :R-dev-args
#+begin_src R :session "global" :file Figure2D.pdf :results output graphics :exports results
  fig2D <- ggplot(mdm2Lo_Treated_vs_UntreatedSig,aes(x=reorder(name,log2fc), y=log2fc, fill = Class)) +
      ggtitle("MDM2 Low Cells") +
      geom_bar(stat = "identity", colour = "black") +
      coord_flip() +
      theme_bw() +
      ylab("log2(mean(Treated)-mean(Untreated))") +
      theme(axis.title.y = element_blank(),axis.title.x = element_text(size=12,face="bold"),axis.text.y=element_text(face="bold"),axis.text.x=element_text(size=10)) +
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
      scale_fill_manual(values=as.vector(myPalette)[c(1,5,3,4,6,2,7)]) #+
      #theme(legend.position="bottom",legend.direction="vertical")
  fig2D
#+end_src

#+RESULTS:
[[file:Figure2D.pdf]]
** Figure 2
#+header: :width 20 :height 10 :R-dev-args
#+begin_src R :session "global" :file Figure2.pdf :results graphics output :exports results
  df <- data.frame()
  fig2A <- ggplot(df) +
      geom_point() +
      xlim(0, 10) +
      ylim(0, 10) +
      theme_void() +
      annotate("text",x=5,y=5,label="Tumor growth")

  new_p1 <- plot_grid(fig2B,
		      fig2C,
		      labels = c('B','C'),
		      rel_heights=c(0.65,0.35),
		      nrow = 2)
  new_p2 <- plot_grid(fig2A,
		      new_p1,
		      labels = c('A',''),
		      nrow = 2)
  figure2<-plot_grid(new_p2,
		     fig2D,
		     labels = c('','D'),
		     ncol = 2)

  figure2
#+end_src

#+RESULTS:
[[file:Figure2.pdf]]

* Figure 3: "DDLPS cell lines respond to cholesterol inhibition"
** Figure 3B
*** Custom version of volcano plotter 
    #+begin_src R :session "global" :exports none
      volcano_plotter <- function(df,gp1,gp2,title){
	  T_test_results<-mydiff(df,gp1,gp2)
	  ## Make insignificant points smaller and more transparent
	  T_test_results$significant = abs(T_test_results$log2fc) > 1 & -log10(T_test_results$mypadj) > -log10(0.1)
	  T_test_results$size <- ifelse(T_test_results$significant,4,2)

	  ## Color code by lipid class
	  T_test_results$MainClass<-lipidomic_key$`LM Main Class`[match(T_test_results$name,lipidomic_key$name)]
	  palette_names<-sort(unique(T_test_results$MainClass))
	  T_test_results$MainClass<-sapply(1:nrow(T_test_results),function(x){
	      ifelse(T_test_results$significant[x],
		     return(T_test_results$MainClass[x]),return("Not Significant"))
	  })

	  legend_labels<-sort(unique(T_test_results$MainClass))

	  palette<-c(brewer.pal(12,"Paired"),"#40E0D0","violet","grey80")
	  names(palette)<-c(palette_names,"Not Significant")
	  palette<-palette[unique(T_test_results$MainClass)]

	  if(any(T_test_results$significant)){
	      g = ggplot(data=T_test_results, aes(x=log2fc, y=-log10(mypadj), colour=MainClass)) +
		  geom_point(alpha=0.7,aes(size=size, text=name)) +
		  scale_color_manual(values = palette,
				     ##na.value="grey80",
				     labels=legend_labels,
				     name="LipidMaps Main Class") +
		  theme_bw() +
		  ggtitle(title) +
		  theme(plot.title = element_text(hjust = 0.5)) +
		  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
		  ylab("-log10 p-value") +
		  geom_hline(yintercept = -log10(0.1),lty = 2) +
		  geom_vline(xintercept = 1, lty = 2) +
		  geom_vline(xintercept = -1, lty = 2) +
		  scale_size(range=c(2,4)) +
		  guides(size=FALSE)
	  }else{
	      g = ggplot(data=T_test_results, aes(x=log2fc, y=-log10(mypadj))) +
		  geom_point(alpha=0.4,aes(text=name)) +
		  scale_color_manual(values = palette) +
		  theme_bw() +
		  ggtitle(title) +
		  theme(plot.title = element_text(hjust = 0.5)) +
		  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
		  ylab("-log10 p-value") +
		  geom_hline(yintercept = -log10(0.1),lty = 2) +
		  geom_vline(xintercept = 1, lty = 2) +
		  geom_vline(xintercept = -1, lty = 2)
	      return(g)
	  }

	  T_test_results_sig<-T_test_results[T_test_results$significant,]
	  text_size<-round(min(20,350/nrow(T_test_results_sig)),digits=0)
	  barplot<-ggplot(T_test_results_sig, aes(x=reorder(name,log2fc), y=log2fc ))+
	      theme_bw() +
	      geom_bar(stat="identity",colour="black",aes(fill = MainClass)) +
	      scale_fill_manual(values = palette) +
	      coord_flip() +
	      ylab("log2fc") +
	      theme(axis.title.y = element_blank(),axis.title.x = element_text(size=12,face="bold"),axis.text.y=element_text(size=text_size),axis.text.x=element_text(size=10)) +
	      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

	  return(list(g,barplot))
      }
    #+end_src

*** Figure
    #+header: :width 12 :height 6 :R-dev-args
    #+begin_src R :session "global" :file Figure3B.pdf :results output graphics :exports results
      library(readxl)
      library(RColorBrewer)
      load("~/Desktop/Liposarcoma project/final_figures/final_figures_org_file/figure3.Rda")
      lipidomic_key<-read_xlsx("~/Desktop/Liposarcoma project/Lipidomics_key.xlsx",sheet=1)
      p1<-volcano_plotter(LM_area,
			  groupMDM2Hi_Treated_DMEM,
			  groupMDM2Lo_Treated_DMEM,
			  "Treated Cells Grown in Normal Media")[[1]] +
	  xlab("log2(mean(MDM2Hi))-log2(mean(MDM2Lo))")

      p2<-volcano_plotter(LM_area,
			  groupMDM2Hi_Untreated_DMEM,
			  groupMDM2Lo_Untreated_DMEM,
			  "Untreated Cells Grown in Normal Media")[[1]] +
	  xlab("log2(mean(MDM2Hi))-log2(mean(MDM2Lo))") +
	  theme(legend.position="none")
      fig3B <- plot_grid(p2, p1, align="h", nrow=1, rel_widths = c(0.6,1))
      fig3B
    #+end_src

    #+RESULTS:
    [[file:Figure3B.pdf]]

** Figure 3C (Treated vs. Untreated lipids, MDM2 high, normal media)
   #+header: :width 8 :height 12 :R-dev-args
   #+begin_src R :session "global" :file Figure3C.pdf :results output graphics :exports results
     fig3C <- volcano_plotter(LM_area,
		     groupMDM2Hi_Treated_DMEM,
		     groupMDM2Hi_Untreated_DMEM,
		     "MDM2 High Cells Grown in Normal Media")[[2]] +
	 ylab("log2(mean(Treated))-log2(mean(Untreated))")# +
	 #theme(legend.position="bottom",legend.direction="vertical",axis.text.y = element_text(face="bold"))
     fig3C
   #+end_src

   #+RESULTS:
   [[file:Figure3C.pdf]]
** Figure 3D (Treated vs. Untreated lipids, MDM2 low, sterol-deprived media)
   #+header: :width 8 :height 12 :R-dev-args
   #+begin_src R :session "global" :file Figure3D.pdf :results output graphics :exports results
     fig3D <- volcano_plotter(LM_area,
		     groupMDM2Lo_Treated_DMEM,
		     groupMDM2Lo_Untreated_DMEM,
		     "MDM2 Low Cells Grown in Normal Media")[[2]] +
	 ylab("log2(mean(Treated))-log2(mean(Untreated))") + ggtitle("MDM2 Low Cells Grown in Normal Media")# +
     ##theme(legend.position="bottom",legend.direction="vertical",axis.text.y = element_text(face="bold"))
     fig3D
   #+end_src

   #+RESULTS:
   [[file:Figure3D.pdf]]
** Figure 3
#+header: :width 20 :height 10 :R-dev-args
#+begin_src R :session "global" :file Figure3.pdf :results graphics output :exports results
  df <- data.frame()
  fig3A <- ggplot(df) +
      geom_point() +
      xlim(0, 10) +
      ylim(0, 10) +
      theme_void() +
      annotate("text",x=5,y=5,label="Changes in spheroid formation")
  new_p1 <- plot_grid(fig3A,
		      fig3B,
		      labels = c('A','B'),
		      nrow = 2)

  figure3 <- plot_grid(new_p1,
		       fig3D,
		       labels = c('','C'),
		       ncol = 2)

  figure3
#+end_src

#+RESULTS:
[[file:Figure3.pdf]]
** Fig 3 Venn Diagrams
#+NAME: Figure_3E
#+header: :width 10 :height 10 :R-dev-args
#+BEGIN_SRC R :session "global" :file Figure_3E.pdf :results output graphics :export both
library(ggforce)
untreated_DMEM <-  mydiff(LM_area, 
			  groupMDM2Hi_Untreated_DMEM,
			  groupMDM2Lo_Untreated_DMEM)

treated_DMEM <-  mydiff(LM_area, 
                        groupMDM2Hi_Treated_DMEM,
                        groupMDM2Lo_Treated_DMEM)

untreated_DMEM_sig <- untreated_DMEM %>%
  filter(mypadj < 0.05, log2fc > 1)

treated_DMEM_sig <- treated_DMEM %>%
  filter(mypadj < 0.05, log2fc > 1)

df.venn <- data.frame(x = c(1.2, -1.2),
                      y = c(0, 0),
                      labels = c('Untreated', 'Treated'))
intersect_count = length(intersect(untreated_DMEM_sig$name,treated_DMEM_sig$name))
df.vdc<-data.frame(Count = c(intersect_count,
                             nrow(treated_DMEM_sig)-intersect_count,
                             nrow(untreated_DMEM_sig)-intersect_count),
                   x = c(0, -1.3, 1.3),
                   y = c(0,0,0))

fig3E.1 <- ggplot(df.venn, aes(x0 = x, y0 = y, r = 1.5, fill = labels)) +
  scale_fill_brewer(palette="Dark2") +
  geom_circle(alpha = .5, size = 1, colour = 'grey') +
  coord_fixed() +
  theme_void() +
  labs(fill = NULL) +
  annotate("text", x = df.vdc$x, y = df.vdc$y, label = df.vdc$Count, size = 7) +
  ggtitle("Lipids upregulated in MDM2 High cells compared to MDM2 Low (Standard Media)")

untreated_DMEM_sig <- untreated_DMEM %>%
  filter(mypadj < 0.05, log2fc < -1)

treated_DMEM_sig <- treated_DMEM %>%
  filter(mypadj < 0.05, log2fc < -1)

df.venn <- data.frame(x = c(1.2, 0),
                      y = c(0, 0),
                      r = c(1,1.2),
                      labels = c('Untreated', 'Treated'))
intersect_count = length(intersect(untreated_DMEM_sig$name,treated_DMEM_sig$name))
df.vdc<-data.frame(Count = c(intersect_count,
                             nrow(treated_DMEM_sig)-intersect_count,
                             nrow(untreated_DMEM_sig)-intersect_count),
                   x = c(.7, -.3, 1.5),
                   y = c(0,0,0))
fig3E.2 <- ggplot(df.venn, aes(x0 = x, y0 = y, r = r, fill = labels)) +
  scale_fill_brewer(palette="Dark2") +
  geom_circle(alpha = .5, size = 1, colour = 'grey') +
  coord_fixed() +
  theme_void() +
  labs(fill = NULL) +
  annotate("text", x = df.vdc$x, y = df.vdc$y, label = df.vdc$Count, size = 7) +
  ggtitle("Lipids upregulated in MDM2 Low cells compared to MDM2 High (Standard Media)")

plot_grid(fig3E.1,
          fig3E.2,
          ncol=1)

#+END_SRC

#+RESULTS: Figure_3E
[[file:Figure_3E.pdf]]

* Figure 5: "Involvement of sphingolipid synthesis in humans"
** Figure 5A
#+header: :width 8 :height 12 :R-dev-args
#+begin_src R :session "global" :file Figure5A.pdf :results output graphics :exports results
  load( "~/Desktop/Liposarcoma project/final_figures/final_figures_org_file/fig5A.Rda")
  corr_plotter<-function(gene){
      ind<-match(gene,gn)
      MDM2_corr_ind<-match(gene, MDM2_correlations_chibon$gn..MDM2_Probe.)
      plot.df<-data.frame(MDM2=chibon_data_exprs[MDM2_Probe,],gene=chibon_data_exprs[ind,])
      corr_coef <- round(cor(plot.df$MDM2, plot.df$gene, method="spearman"), digits=5)
      corr_test <- round(MDM2_correlations_chibon$MDM2_corr_test_chibon_adj[MDM2_corr_ind], digits=5)

      p<-ggplot(plot.df,aes(x=MDM2,y=gene)) +
	  geom_point() +
	  theme_classic() +
	  geom_smooth(method=lm,color="black") +
	  ylab(gene) +
	  ggtitle(paste0("Spearman rho = ", corr_coef,"\n Adjusted p = ", corr_test))
      return(p)
  }

  for(i in 1:length(sphingolipid_genes)){
      assign(paste0("fig5A_",i),corr_plotter(sphingolipid_genes[i]))
  }


  fig5A <- plot_grid(fig5A_1,
		     fig5A_2,
		     fig5A_3,
		     fig5A_4,
		     fig5A_5,
		     fig5A_6,
		     ncol=2)
  fig5A
#+end_src

#+RESULTS:
[[file:Figure5A.pdf]]
** Figure 5
#+header: :width 20 :height 10 :R-dev-args
#+begin_src R :session "global" :file Figure5.pdf :results output graphics :exports results
  df <- data.frame()
    fig5B <- ggplot(df) +
	geom_point() +
	xlim(0, 10) +
	ylim(0, 10) +
	theme_void() +
	annotate("text",x=5,y=5,label="Final model")
    fig5 <- plot_grid(fig5A,
			fig5B,
			labels = c('A','B'),
			ncol = 2)
  fig5
#+end_src

#+RESULTS:
[[file:Figure5.pdf]]

* Figure S1: "MDM2 status and metabolomic profiling in DDLPS cell lines"
** Figure S1B
#+header: :width 8 :height 8 :R-dev-args
#+begin_src R :session "global" :file FigureS1B.pdf :results output graphics :export both
  metabolon_superpathways <- read_csv("~/Desktop/Liposarcoma project/final_figures/final_figures_org_file/Metabolon_superpathways.csv")
  colnames(metabolon_superpathways) <- "pathway"
  metabolon_superpathways <- within(metabolon_superpathways, 
				    pathway <- factor(pathway,levels=names(sort(table(pathway), decreasing=TRUE))))
  figS1B <- ggplot(metabolon_superpathways, aes(pathway)) +
      geom_histogram(stat="count",color="black",fill="gray") +
      theme(axis.text.x=element_text(angle=45,hjust=1)) +
      labs(x = "Metabolon Superpathway",y = "# of Metabolites")
  figS1B	
#+end_src

#+RESULTS:
[[file:FigureS1B.pdf]]

** Figure S1C
#+header: :width 8 :height 8 :R-dev-args
#+begin_src R :session "global" :file FigureS1C.pdf :results output graphics :export both
mycol=c("red","blue")
mytitle="MDM2 high and low cell lines, untreated"
load("~/Desktop/Liposarcoma project/final_figures/final_figures_org_file/figureS1C.Rda")
figS1C <- ggplot(mydf,aes(PC1,PC2,color=Status,shape=Cell)) +
  geom_point(aes(PC1,PC2,shape=Cell),size=4) +
  scale_color_manual(values=mycol) +
  xlab(paste0("PC1: ",percvar[1],"% variance")) +
  ylab(paste0("PC2: ",percvar[2],"% variance")) +
  theme_bw() +
  ggtitle(mytitle) +
  theme(axis.line = element_line(colour = "black"),
        axis.title=element_text(size=12,face="bold"),
        plot.title=element_text(size=14,face="bold"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank())
figS1C

#+end_src

#+RESULTS:
[[file:FigureS1C.pdf]]

** Figure S1D
#+header: :width 18 :height 3 :R-dev-args
#+begin_src R :session "global" :file FigureS1D.pdf :results output graphics :export both
  load("~/Desktop/Liposarcoma project/final_figures/final_figures_org_file/figureS1D.Rda")

  boxplotter <- function(analyte) {
    analyteInd <- match(analyte, rownames(metabFiltered))
    BPdf <- data.frame(status = mystatus[mysamps], value = t(metabFiltered[analyteInd,
        mysamps]))
    colnames(BPdf) <- c("status", "log2Abundance")

    p <- ggplot(BPdf, aes(x = status, y = log2Abundance, fill = status)) +
        ggtitle(paste0(analyte, ", \npadj = ", round(resMDM2HiLo$mypadj[analyteInd],
            digits = 3), ", \nlog2FC = ", round(resMDM2HiLo$log2fc[analyteInd],
            digits = 3))) + geom_boxplot() +
        scale_fill_manual(values = mycol) +
        theme_bw() +
        theme(
            #plot.title = element_text(size = 8),
            legend.position = "none",axis.title.x=element_blank(), panel.grid.major = element_blank(),
            panel.grid.minor = element_blank())

    return(p)
}
  
  figS1D <- plot_grid(boxplotter("glycosyl-N-palmitoyl-sphingosine"),
		      boxplotter("glycosyl-N-stearoyl-sphingosine"),
		      boxplotter("sphingomyelin (d18:1/17:0, d17:1/18:0, d19:1/16:0)"),
		      nrow=1)
  figS1D
#+end_src

#+RESULTS:
[[file:FigureS1D.pdf]]

** Figure S1
#+header: :width 20 :height 10 :R-dev-args
#+begin_src R :session "global" :file FigureS1.pdf :results graphics output :exports results
  df <- data.frame()
  figS1A <- ggplot(df) +
      geom_point() +
      xlim(0, 10) +
      ylim(0, 10) +
      theme_void() +
      annotate("text",x=5,y=5,label="MDM2 Western Blot")

  new_p1 <- plot_grid(figS1A,
		      figS1B,
		      figS1C,
		      labels = c('A','B','C'),
		      nrow = 1,
		      rel_widths = c(.5,.2,.3))
  figureS1<-plot_grid(new_p1,
		      NULL,
		      figS1D,
		      labels = c('','','D'),
		      rel_heights=c(1,0.1,0.5),
		      nrow = 3)

  figureS1
#+end_src

#+RESULTS:
[[file:FigureS1.pdf]]

* Figure S3: "Lipidome analysis in DDLPS cell lines"
** Figure S3A
   #+header: :width 12 :height 8 :R-dev-args
   #+begin_src R :session "global" :file FigureS3A.pdf :results output graphics :exports results
     library(tidyverse)
     load("~/Desktop/Liposarcoma project/final_figures/final_figures_org_file/figure4a.Rda")

     lipid_BP_DF <- lipid_BP_DF %>%
	 mutate(lipid_main_classes = factor(lipid_main_classes, levels = unique(lipid_main_classes)))

     lipid_BP_DF$Group <- apply(lipid_BP_DF,1,function(x){
       if(length(which(!is.na(match(lipid_BP_DF$lipid_main_classes,x[1]))))>1){
	 return("Both Panels")
       }else{
	 return(paste0(x[3]," Panel Only"))
       }
     })

     lipid_BP_DF <- within(lipid_BP_DF, 
			Group <- factor(Group, 
					levels=names(sort(table(Group), 
							  decreasing=TRUE))))

     figS3A <- lipid_BP_DF %>%
       ##arrange(Group) %>%
       ggplot(aes(x=lipid_main_classes,y=Freq)) +
       geom_bar(stat = "identity",position="dodge",aes(fill=dataset),colour="black") +
       facet_grid(. ~ Group, scales = "free", space = "free") +
       scale_fill_manual(values = c("#E1B378","#5F9EA0")) +
       xlab("") +
       ylab("# of species") +
       scale_y_continuous(limits=c(0,200)) +
       ggtitle("Lipid Panel Composition by LipidMaps main class") +
       guides(fill=guide_legend(title="")) +
       theme(axis.line = element_line(colour = "black"),
	     axis.text.x = element_text(angle = 45, hjust = 1,face="bold"),
	     axis.title=element_text(size=12,face="bold"),
	     plot.title=element_text(size=14,face="bold"),
	     panel.grid.minor = element_blank(),
	     panel.background = element_blank())
     figS3A
   #+end_src
   #+RESULTS:
   [[file:FigureS3A.pdf]]
** Figure S3B
   #+header: :width 12 :height 8 :R-dev-args
   #+begin_src R :session "global" :file FigureS3B.pdf :results output graphics :exports results
     p1<-volcano_plotter(LM_area,
			 groupMDM2Hi_Untreated_STDP,
			 groupMDM2Lo_Untreated_STDP,
			 "Untreated Cells Grown in Sterol-Deprived Media")[[1]] +
	 xlab("log2(mean(MDM2Hi))-log2(mean(MDM2Lo))") +
	 ylim(c(0,4))
     p2<-volcano_plotter(LM_area,
			 groupMDM2Hi_Untreated_DMEM,
			 groupMDM2Lo_Untreated_DMEM,
			 "Treated Cells Grown in Normal Media")[[1]] +
	 xlab("log2(mean(MDM2Hi))-log2(mean(MDM2Lo))") +
	 theme(legend.position="none") +
	 ylim(c(0,4))
     figS3B <- plot_grid(NULL, p2, NULL, p1, align="h", nrow=1, rel_widths = c(0.05,0.5,0.15,1))
     figS3B
   #+end_src

   #+RESULTS:
   [[file:FigureS3B.pdf]]

** Figure S3C
   #+header: :width 8 :height 12 :R-dev-args
   #+begin_src R :session "global" :file FigureS3C.pdf :results output graphics :exports results
     figS3C <- volcano_plotter(LM_area,
		     groupMDM2Hi_Treated_DMEM,
		     groupMDM2Lo_Treated_DMEM,
		     "Treated Cells Grown in Normal Media")[[2]] +
	 ylab("log2(mean(MDM2Hi))-log2(mean(MDM2Lo))") +
	 theme(axis.text.y = element_text(face="bold",angle=30,size=7)) +
	 ggtitle("Treated Cells Grown in Normal Media")
	 #theme(legend.position="bottom",legend.direction="vertical",axis.text.y = element_text(face="bold"))
     figS3C
   #+end_src

   #+RESULTS:
   [[file:FigureS3C.pdf]]
** Figure S3
#+header: :width 20 :height 10 :R-dev-args
#+begin_src R :session "global" :file FigureS3.pdf :results graphics output :exports results
  new_p1 <- plot_grid(figS3A,
		      figS3B,
		      labels = c('A','B'),
		      nrow = 2,
		      rel_heights = c(1,0.6))
  figureS3<-plot_grid(new_p1,
		     figS3C,
		     labels = c('','C'),
		     rel_widths = c(1,0.7),
		     ncol = 2)

  figureS3
#+end_src

#+RESULTS:
[[file:FigureS3.pdf]]

** Venn Diagrams
#+NAME: FigureS3D
#+header: :width 10 :height 10 :R-dev-args
#+BEGIN_SRC R :session "global" :file FigureS3D.pdf :results output graphics :export both

untreated_STDP <-  mydiff(LM_area, 
                          groupMDM2Hi_Untreated_STDP,
                          groupMDM2Lo_Untreated_STDP)

untreated_DMEM_sig <- untreated_DMEM %>%
  filter(mypadj < 0.05, log2fc > 1)

untreated_STDP_sig <- untreated_STDP %>%
  filter(mypadj < 0.05, log2fc > 1)

df.venn <- data.frame(x = c(.8, -.8),
                      y = c(0, 0),
                      labels = c('Standard Media', 'Sterol-Deprived Media'))
intersect_count = length(intersect(untreated_STDP_sig$name,untreated_DMEM_sig$name))
df.vdc<-data.frame(Count = c(intersect_count,
                             nrow(untreated_STDP_sig)-intersect_count,
                             nrow(untreated_DMEM_sig)-intersect_count),
                   x = c(0, -1.3, 1.3),
                   y = c(0,0,0))

figS3D.1 <- ggplot(df.venn, aes(x0 = x, y0 = y, r = 1.5, fill = labels)) +
    scale_fill_brewer(palette="Dark2") +
    geom_circle(alpha = .5, size = 1, colour = 'grey') +
    coord_fixed() +
    theme_void() +
    labs(fill = NULL) +
    annotate("text", x = df.vdc$x, y = df.vdc$y, label = df.vdc$Count, size = 7) +
    ggtitle("Lipids upregulated in MDM2 High cells compared to MDM2 Low (Untreated)") +
    theme(legend.text=element_text(size=16))

untreated_DMEM_sig <- untreated_DMEM %>%
  filter(mypadj < 0.05, log2fc < -1)

untreated_STDP_sig <- untreated_STDP %>%
  filter(mypadj < 0.05, log2fc < -1)

df.venn <- data.frame(x = c(1.2, 0),
                      y = c(0, 0),
                      r = c(1.2,1),
                      labels = c('Standard Media', 'Sterol-Deprived Media'))
intersect_count = length(intersect(untreated_DMEM_sig$name,untreated_STDP_sig$name))
df.vdc<-data.frame(Count = c(intersect_count,
                             nrow(untreated_STDP_sig)-intersect_count,
                             nrow(untreated_DMEM_sig)-intersect_count),
                   x = c(.4, -.4, 1.5),
                   y = c(0,0,0))
figS3D.2 <- ggplot(df.venn, aes(x0 = x, y0 = y, r = r, fill = labels)) +
  scale_fill_brewer(palette="Dark2") +
  geom_circle(alpha = .5, size = 1, colour = 'grey') +
  coord_fixed() +
  theme_void() +
  labs(fill = NULL) +
  annotate("text", x = df.vdc$x, y = df.vdc$y, label = df.vdc$Count, size = 7) +
    ggtitle("Lipids upregulated in MDM2 Low cells compared to MDM2 High (Untreated)") +
    theme(legend.text=element_text(size=16))

plot_grid(figS3D.1,
          figS3D.2,
          ncol=1)

#+END_SRC

#+RESULTS: FigureS3D
[[file:FigureS3D.pdf]]
* Additional figure: "Concordance of Metabolomic and Lipidomic Differences in MDM2 Low vs. High"

#+NAME: additional_figure
#+header: :width 12 :height 8 :R-dev-args
#+BEGIN_SRC R :session "global" :file additional_figure.pdf :results output graphics :export both
library(readxl)

lipidomics_classes<-
    read_excel("~/Desktop/Liposarcoma project/Lipidomics_key.xlsx",
               sheet=1)
metabolomics_classes<-
    read_excel("~/Desktop/Liposarcoma project/Lipidomics_key.xlsx",
               sheet=2)
untreated_DMEM_sig <- untreated_DMEM %>%
  filter(mypadj < 0.05, abs(log2fc) > 1)

resMDM2HiLoSig$mainclass <-
    metabolomics_classes$`LM Main Class`[match(resMDM2HiLoSig$name,
                                               metabolomics_classes$name)] 

resMDM2HiLoSig <-
    resMDM2HiLoSig %>%
    filter(!is.na(mainclass)) %>%
    filter(mainclass != "Non-lipid in lipid pathways")

untreated_DMEM_sig$mainclass <-
    lipidomics_classes$`LM Main Class`[match(untreated_DMEM_sig$name,
                                             lipidomics_classes$name)] 
fill <- c("#E1B378","#5F9EA0")

metabolites_hi <- resMDM2HiLoSig %>% filter(log2fc > 0)
lipids_hi <- untreated_DMEM_sig %>% filter(log2fc > 0) 

barplot_df_hi <-
    data.frame(mainclass = c(metabolites_hi$mainclass,lipids_hi$mainclass),
               dataset = c(rep("Metabolomic",nrow(metabolites_hi)),
                           rep("Lipidomic",nrow(lipids_hi))),
               direction = 1)

barplot_df_hi<-aggregate(direction ~ mainclass + dataset,
                         data=barplot_df_hi, FUN=sum)

metabolites_lo <- resMDM2HiLoSig %>% filter(log2fc < 0)
lipids_lo <- untreated_DMEM_sig %>% filter(log2fc < 0) 

barplot_df_lo <-
    data.frame(mainclass = c(metabolites_lo$mainclass,lipids_lo$mainclass),
               dataset = c(rep("Metabolomic",nrow(metabolites_lo)),
                           rep("Lipidomic",nrow(lipids_lo))),
               direction = -1)

barplot_df_lo<-aggregate(direction ~ mainclass + dataset,
                         data=barplot_df_lo, FUN=sum)
barplot_df <- rbind(barplot_df_hi,barplot_df_lo)

additional_figure<-ggplot(barplot_df,aes(x=mainclass,fill = dataset,y = direction)) +
    geom_bar(stat="identity",colour="black") +
    scale_fill_manual(values=fill) +
    theme(axis.title.y = element_blank(),
          plot.margin = unit(c(1,3,1,1), "lines")) +
    scale_y_continuous("Count", breaks = seq(-15,5,5),
                       labels = c("15","10","5","0","5")) +
    geom_hline(yintercept=0,size=2) +
    coord_flip() +
    expand_limits(x = c(0, 16)) +
    ggtitle("Significant Differences between MDM2 High and Low Cells\nby LipidMaps Main Class") +
    annotate("text",y=-10,x=15.3,label = "Higher in MDM2 Low",size=3) +
    annotate("text",y=4,x=15.3,label = "Higher in MDM2 High",size=3)
additional_figure

#+END_SRC

#+RESULTS: additional_figure
[[file:additional_figure.pdf]]


* Poster figures
** Figure 1
#+NAME: HivsLoUntreatedDMEM
#+header: :width 1000 :height 1000 :R-dev-args
#+BEGIN_SRC R :session "global" :file HivsLoUntreatedDMEM.png :results output graphics :export both
poster_fig1c<-volcano_plotter(LM_area,
                              groupMDM2Hi_Untreated_DMEM,
                              groupMDM2Lo_Untreated_DMEM,
                              "MDM2 High vs MDM2 Low")[[1]]+xlab("log2(mean(MDM2Hi))-log2(mean(MDM2Lo))")
poster_fig1c
#+END_SRC

#+RESULTS: HivsLoUntreatedDMEM
[[file:HivsLoUntreatedDMEM.png]]

#+NAME: Poster_figure_1
#+header: :width 21 :height 16 :R-dev-args
#+BEGIN_SRC R :session "global" :file Poster_figure_1.pdf :results output graphics :export both
load("~/Desktop/Liposarcoma project/final_figures/final_figures_org_file/figure1C.Rda")
myPalette<-c("#8B008B","#808080","#008080","#46f0f0","#f58231","#3cb44b","#e6194b")
fig1C <- ggplot(resMDM2HiLoSig,aes(x=reorder(name,log2fc), y=log2fc, fill = Class)) +
      ggtitle("Significant MDM2 Hi/Lo Metabolites") +
      geom_bar(stat = "identity", colour = "black") +
      coord_flip() +
      theme_bw() +
      ylab("log2(mean(MDM2hi)-mean(MDM2lo))") +
    theme(axis.title.y = element_blank(),
          axis.title.x = element_text(size=12,face="bold"),
          axis.text.y=element_text(size=10,face="bold"),
          axis.text.x=element_text(size=10)) +
    theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank()) +
    scale_fill_manual(values=as.vector(myPalette)[c(1,2,5,3,4,6,7)])

## poster_subfigure<-plot_grid(poster_fig1c,
##                             figS3A,
##                             ncol=1,
##                             labels=c('C','D'),
##                             rel_heights = c(0.3,0.6))

poster_fig1<-plot_grid(fig1C,
                       fig1B,
                                        #poster_subfigure,
                       poster_fig1c,
                       figS3A,
                       labels = c('A','B','C','D'),
                       rel_widths = c(1,1),
                       ncol = 2)

poster_fig1
#+END_SRC

#+RESULTS: Poster_figure_1
[[file:Poster_figure_1.pdf]]

#+NAME: Poster_figure_2
#+header: :width 21 :height 7 :R-dev-args
#+BEGIN_SRC R :session "global" :file Poster_figure_2.pdf :results output graphics :export both
poster_fig2a <- volcano_plotter(LM_area,
                                c(groupMDM2Hi_Treated_DMEM, groupMDM2Lo_Treated_DMEM),
                                c(groupMDM2Hi_Untreated_DMEM,groupMDM2Lo_Untreated_DMEM),
                                "Atorvastatin Treated vs. Untreated") +
    xlab("log2(mean(Treated))-log2(mean(Untreated))")
poster_fig2b <- volcano_plotter(LM_area,
                                c(groupMDM2Hi_Untreated_STDP, groupMDM2Lo_Untreated_STDP),
                                c(groupMDM2Hi_Untreated_DMEM,groupMDM2Lo_Untreated_DMEM),
                                "Sterol Deprived vs. Standard Media")[[1]] +
    xlab("log2(mean(STDP))-log2(mean(DMEM))") +
    guides(color=FALSE)
poster_fig2c <- volcano_plotter(LM_area,
                                c(groupMDM2Hi_Treated_STDP, groupMDM2Lo_Treated_STDP),
                                c(groupMDM2Hi_Untreated_DMEM,groupMDM2Lo_Untreated_DMEM),
                                "Sterol Deprived and Atorvastatin Treated vs. Standard Media")[[1]] +
    xlab("log2(mean(STDP + Treated))-log2(mean(DMEM + Untreated))")

plot_grid(poster_fig2a,
          poster_fig2b,
          poster_fig2c,
          nrow=1,
          rel_widths = c(1,1,1.3),
          labels=c("A","B","C"))

#+END_SRC

#+RESULTS: Poster_figure_2
[[file:Poster_figure_2.pdf]]
