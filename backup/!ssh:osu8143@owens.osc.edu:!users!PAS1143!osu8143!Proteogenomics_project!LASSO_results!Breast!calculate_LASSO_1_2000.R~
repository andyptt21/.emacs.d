library(caret)
library(glmnet)
library(dplyr)
library(elasticnet)

load("/users/PAS1143/osu8143/Proteogenomics_project/dataForCorrTesting.Rda")

nrmse<-function(predictions,actual){
  if(length(predictions)!=length(actual)){
    return("Length of prediction vector did not equal length of actual vector")
  }else{
    ## Get rid of missing values
    if(any(is.na(c(predictions,actual)))){
      missing_pred<-which(is.na(predictions))
      missing_actual<-which(is.na(actual))
      incomplete<-c(missing_pred,missing_actual)
      predictions<-predictions[-incomplete]
      actual<-actual[-incomplete]
    }
    numerator<-sapply(1:length(predictions), function(x){
      return((actual[x]-predictions[x])^2/length(predictions))
    })
    return(sqrt(sum(numerator))/(max(actual)-min(actual)))
  }
}

############################
# Remove transcripts with any missing values
#############################
breastRNA <- breastRNA[,complete.cases(t(breastRNA))]

##############################################################
# Breast
##############################################################
breastRNA<-t(breastRNA)
trainSet <- breastRNA

fitControl <- trainControl(method = "cv",
                           number = 10,
                           savePredictions = 'final')

breastLR <- sapply(1:2000, function(x){
  ptm <- proc.time()
  trainType <- breastProtein[x,]
  Proteincc<-complete.cases(trainType)
  if(length(which(Proteincc)) < 39){
    return(c(NA,NA))
  }else{
    trainType <- trainType[Proteincc]
    trainSet <- trainSet[Proteincc,]
    model_lasso <- train(trainSet,trainType,
                         method='lasso',
                         trControl = fitControl)
    predictions<-model_lasso$pred
    predictions<-predictions[which(!is.na(predictions$pred)),]
    if(nrow(predictions)<6){
      return(c(NA,NA))
    }else{
      cor<-cor(predictions$pred,predictions$obs,method="spearman")
      nrmse<-nrmse(predictions$pred,predictions$obs)
      print(paste0(x," proteins completed!"))
      print(proc.time() - ptm)
      return(c(cor,nrmse))
    }
  }
})

save(breastLR,file = "~/Proteogenomics_project/LASSO_results/Breast/Breast_1_2000.Rda")
